# 门店自配送配送范围管理说明

## 📋 功能概述

门店自配送的配送范围管理允许商家为每个门店配置配送范围（半径），系统会根据门店经纬度和收货地址经纬度计算距离，判断是否在配送范围内。

## 🔧 功能实现

### 1. 门店列表展示

- **数据来源**：复用门店自提的门店列表（`DeliveryPickUpStoreApi`）
- **显示字段**：
  - 门店编号
  - 门店名称
  - 门店地址
  - 联系电话
  - 经纬度（latitude, longitude）
  - **配送范围（半径）** - 可编辑
  - 状态

### 2. 配送范围配置

- **配置方式**：在表格中直接编辑配送范围（半径），单位：公里
- **默认值**：5km（如果门店没有配置过配送范围）
- **实时保存**：修改后自动保存（调用 `handleStoreRangeChange` 方法）

### 3. 搜索功能

- 支持按门店名称搜索
- 支持重置搜索条件

### 4. 门店编辑

- 点击"编辑门店"按钮，可以编辑门店的基本信息
- 复用门店自提的门店表单（`PickUpStoreForm`）

## 💡 业务逻辑

### 配送范围判断

```
1. 获取门店经纬度（latitude, longitude）
2. 获取收货地址经纬度
3. 计算两点之间的距离（使用经纬度距离计算公式）
4. 判断距离是否 <= 门店配送范围（半径）
   - 是 → 支持门店自配送
   - 否 → 不支持门店自配送，提示用户超出配送范围
```

### 距离计算公式

常用的经纬度距离计算公式：
- **Haversine公式**：适用于地球表面的两点距离计算
- **距离单位**：公里（km）

示例代码：
```javascript
// Haversine公式计算两点距离（公里）
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371 // 地球半径（公里）
  const dLat = (lat2 - lat1) * Math.PI / 180
  const dLon = (lon2 - lon1) * Math.PI / 180
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2)
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
  return R * c
}
```

## 📊 数据存储

### 当前实现（前端）

- **数据结构**：在门店数据中添加 `deliveryRange` 字段（配送范围半径，单位：公里）
- **默认值**：5km
- **存储位置**：TODO - 需要后端API支持保存门店配送范围配置

### 建议的后端实现

1. **数据库表设计**：
   - 可以在 `pick_up_store` 表中添加 `delivery_range` 字段（INT，单位：米或公里）
   - 或者创建单独的门店配送范围配置表

2. **API接口**：
   - `GET /trade/delivery/pick-up-store/{id}` - 获取门店详情（包含配送范围）
   - `PUT /trade/delivery/pick-up-store/update-range` - 更新门店配送范围

## 🔄 与其他功能的关系

### 与门店自提的关系

- **共用门店列表**：门店自提和门店自配送使用同一个门店列表
- **独立配置**：门店自提无需配送范围，门店自配送需要配置配送范围
- **门店基本信息共享**：门店名称、地址、经纬度等信息共享

### 与配送费计算的关系

1. **配送范围判断**：先判断是否在配送范围内
2. **配送费计算**：如果在范围内，根据配置的计费方式计算配送费
   - 按距离计费：根据门店到收货地址的距离计算
   - 固定费用：统一收取固定配送费
   - 自定义费用：用户手动填写

## 📝 使用说明

### 配置步骤

1. **启用门店自配送**：在"门店自配送"Tab页，开启"启用门店自配送"开关
2. **配置收费方式**：选择计费方式（按距离计费/固定费用/自定义费用）
3. **配置配送范围**：
   - 在"门店配送范围管理"部分，查看所有门店列表
   - 为每个门店设置配送范围（半径），例如：5km、10km、15km
   - 修改后自动保存

### 配置建议

- **核心商圈门店**：配送范围可以设置较大，如10-15km
- **社区门店**：配送范围可以设置较小，如3-5km
- **偏远门店**：根据实际配送能力设置，如5-8km

## ⚠️ 注意事项

1. **距离计算准确性**：配送范围判断依赖准确的经纬度数据
   - 门店经纬度：从门店信息中获取
   - 收货地址经纬度：需要用户在APP端选择收货地址时获取

2. **实时性**：配送范围修改后，新订单会立即生效

3. **数据一致性**：确保门店经纬度数据的准确性，否则距离计算会有误差

4. **后端API待实现**：当前实现中，`handleStoreRangeChange` 方法只显示成功提示，实际保存需要后端API支持

## 🚀 后续优化建议

1. **批量配置**：支持批量设置多个门店的配送范围
2. **地图可视化**：在地图上显示门店位置和配送范围（圆形区域）
3. **配送范围模板**：预设几种配送范围模板，快速应用到门店
4. **配送范围验证**：配置时验证配送范围的合理性（不能太大或太小）

