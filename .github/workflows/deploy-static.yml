name: éƒ¨ç½²é™æ€æ–‡ä»¶åˆ°æœåŠ¡å™¨

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²é™æ€æ–‡ä»¶
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Node.js
      - name: ğŸ”§ è®¾ç½® Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      # 3. å®‰è£… pnpm
      - name: ğŸ“¥ å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      # 4. è·å– pnpm store ç›®å½•
      - name: ğŸ—‚ï¸ è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      # 5. ç¼“å­˜ä¾èµ–
      - name: ğŸ’¾ ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      # 6. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install --no-frozen-lockfile
      
      # 7. æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆç”Ÿæˆé™æ€æ–‡ä»¶ï¼‰
      - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:prod
      
      # 8. éªŒè¯æ„å»ºäº§ç‰©
      - name: âœ… éªŒè¯é™æ€æ–‡ä»¶
        run: |
          if [ ! -d "dist-prod" ]; then
            echo "âŒ é”™è¯¯ï¼šdist-prod ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… é™æ€æ–‡ä»¶æ„å»ºæˆåŠŸ"
          echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh dist-prod/
      
      # 9. æ‰“åŒ…é™æ€æ–‡ä»¶
      - name: ğŸ“¦ æ‰“åŒ…é™æ€æ–‡ä»¶
        run: |
          cd dist-prod
          tar -czf ../dist-prod.tar.gz .
          cd ..
          echo "âœ… æ‰“åŒ…å®Œæˆ"
          ls -lh dist-prod.tar.gz
      
      # 10. ä¸Šä¼ é™æ€æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: ğŸš€ ä¸Šä¼ åˆ°æœåŠ¡å™¨
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          # å®‰è£… sshpass
          sudo apt-get update
          sudo apt-get install -y sshpass
          
          echo "ä¸Šä¼ é™æ€æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          sshpass -p "$SERVER_PASSWORD" scp -o StrictHostKeyChecking=no \
            dist-prod.tar.gz ${SERVER_USER}@${SERVER_HOST}:/tmp/
          
          echo "âœ… ä¸Šä¼ å®Œæˆ"
      
      # 11. éƒ¨ç½²åˆ° Nginx ç›®å½•
      - name: ğŸ“‚ éƒ¨ç½²åˆ° Nginx
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          echo "éƒ¨ç½²é™æ€æ–‡ä»¶åˆ° Nginx ç›®å½•..."
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            # Nginx ç½‘ç«™ç›®å½•ï¼ˆç¡¬ç¼–ç ï¼‰
            SITE_DIR="/www/wwwroot/smartprofit-ecommerce.com"
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°: $SITE_DIR"
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "$SITE_DIR" ] && [ "$(ls -A $SITE_DIR)" ]; then
              echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
              tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $SITE_DIR . 2>/dev/null || true
            fi
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p $SITE_DIR
            # æ¸…ç©ºæ—§æ–‡ä»¶
            echo "ğŸ—‘ï¸ æ¸…ç©ºæ—§æ–‡ä»¶..."
            rm -rf $SITE_DIR/*
            
            # è§£å‹é™æ€æ–‡ä»¶
            echo "ğŸ“‚ è§£å‹é™æ€æ–‡ä»¶åˆ° Nginx ç›®å½•..."
            tar -xzf /tmp/dist-prod.tar.gz -C $SITE_DIR
            
            # è®¾ç½®æƒé™ï¼ˆNginx ç”¨æˆ·ï¼‰
            chown -R www:www $SITE_DIR
            chmod -R 755 $SITE_DIR
            
            # éªŒè¯éƒ¨ç½²
            echo "âœ… éªŒè¯éƒ¨ç½²..."
            ls -lh $SITE_DIR/
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/dist-prod.tar.gz
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      
      # 12. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: âœ… éƒ¨ç½²æˆåŠŸ
        run: |
          echo "ğŸ‰ é™æ€æ–‡ä»¶éƒ¨ç½²æˆåŠŸï¼"
          echo "ç½‘ç«™åœ°å€: https://smartprofit-ecommerce.com"
          echo "æˆ–è®¿é—®: http://${{ secrets.SERVER_HOST }}"

