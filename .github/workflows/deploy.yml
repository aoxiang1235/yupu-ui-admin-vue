name: éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
# è®¾ç½®æƒé™
permissions:
  contents: read
jobs:
  deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      # 2. è®¾ç½® Node.js
      - name: ğŸ”§ è®¾ç½® Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      # 3. å®‰è£… pnpm
      - name: ğŸ“¥ å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      # 4. è·å– pnpm store ç›®å½•
      - name: ğŸ—‚ï¸ è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # 5. ç¼“å­˜ä¾èµ–
      - name: ğŸ’¾ ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 6. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install --no-frozen-lockfile

      # 7. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:prod

      # 8. éªŒè¯æ„å»ºäº§ç‰©
      - name: âœ… éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "dist-prod" ]; then
            echo "âŒ é”™è¯¯ï¼šdist-prod ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥äº†"
            exit 1
          fi
          echo "âœ… dist-prod ç›®å½•å­˜åœ¨"
          ls -la dist-prod/
      
      # 9. æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd dist-prod
          tar -czf ../dist.tar.gz .
          cd ..
          echo "âœ… æ‰“åŒ…å®Œæˆ: dist.tar.gz"
          ls -lh dist.tar.gz

      # 10. ä¸Šä¼ åˆ° GitHub ä½œä¸º Artifact
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-prod
          path: dist-prod/
          retention-days: 1

      # 11. éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆæ”¹ä¸ºç›´æ¥è§¦å‘æœåŠ¡å™¨æ„å»ºï¼‰
      - name: ğŸš€ éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.SERVER_PROJECT_DIR }}
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin master
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            pnpm install
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
            NODE_OPTIONS="--max-old-space-size=6144" pnpm run build:prod
            
            # å¤åˆ¶åˆ°ç½‘ç«™ç›®å½•
            echo "ğŸ“‚ å¤åˆ¶åˆ°ç½‘ç«™ç›®å½•..."
            cp -r dist-prod/* ${{ secrets.SERVER_TARGET }}/
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      # 12. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: âœ… éƒ¨ç½²æˆåŠŸ
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
