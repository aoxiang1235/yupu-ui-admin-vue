# 交易配置表扩展执行清单

## 一、执行前检查

### 1.1 备份数据库
```bash
# 备份数据库（重要！）
mysqldump -u用户名 -p数据库名 trade_config > trade_config_backup_$(date +%Y%m%d_%H%M%S).sql
```

### 1.2 检查现有表结构
```sql
-- 查看现有表结构
DESC trade_config;

-- 查看现有字段数量
SELECT COUNT(*) as field_count FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = '数据库名' AND TABLE_NAME = 'trade_config';
```

### 1.3 确认数据库版本
```sql
-- MySQL版本需要 >= 5.7（支持decimal精度）
SELECT VERSION();
```

## 二、执行步骤

### 2.1 执行 ALTER 语句

```bash
# 方式1：命令行执行
mysql -u用户名 -p数据库名 < 交易配置表扩展ALTER语句.sql

# 方式2：在MySQL客户端中执行
mysql> source /path/to/交易配置表扩展ALTER语句.sql

# 方式3：分步骤执行（推荐，便于排查问题）
# 逐个执行ALTER语句，确认每一步都成功
```

### 2.2 验证执行结果

```sql
-- 1. 检查表结构
DESC trade_config;

-- 2. 检查同城配送字段
SHOW COLUMNS FROM trade_config LIKE 'same_city%';

-- 3. 检查门店自配送字段
SHOW COLUMNS FROM trade_config LIKE 'store%';

-- 4. 检查快递发货字段
SHOW COLUMNS FROM trade_config WHERE Field = 'delivery_express_enabled';

-- 5. 统计总字段数（应该是约70个字段）
SELECT COUNT(*) as total_fields FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = '数据库名' AND TABLE_NAME = 'trade_config';

-- 6. 检查字段默认值
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_DEFAULT, IS_NULLABLE 
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = '数据库名' 
AND TABLE_NAME = 'trade_config' 
AND COLUMN_NAME LIKE 'same_city%' 
ORDER BY ORDINAL_POSITION;
```

### 2.3 验证数据完整性

```sql
-- 检查现有配置数据是否完整
SELECT 
    id,
    delivery_express_enabled,
    delivery_same_city_enabled,
    delivery_store_enabled,
    same_city_charge_mode,
    store_charge_mode
FROM trade_config 
WHERE id = 1;

-- 如果记录不存在，插入默认记录
INSERT INTO trade_config (id) VALUES (1) 
ON DUPLICATE KEY UPDATE id = id;
```

## 三、后端代码调整

### 3.1 实体类（DO）扩展

在 `TradeConfigDO` 中添加新字段：

```java
// 快递发货
@TableField("delivery_express_enabled")
private Boolean deliveryExpressEnabled;

// 同城配送字段（示例）
@TableField("delivery_same_city_enabled")
private Boolean deliverySameCityEnabled;

@TableField("same_city_charge_mode")
private Integer sameCityChargeMode;

@TableField("same_city_start_distance")
private BigDecimal sameCityStartDistance;

@TableField("same_city_start_price")
private Integer sameCityStartPrice; // 单位：分

// ... 其他字段
```

### 3.2 VO类扩展

在 `TradeConfigVO` 中添加新字段，金额字段使用 `BigDecimal`：

```java
// 金额字段使用BigDecimal（前端显示用元）
private BigDecimal sameCityStartPrice; // 前端以元为单位

// 距离字段使用BigDecimal
private BigDecimal sameCityStartDistance;
```

### 3.3 转换逻辑

在 Service 层添加金额转换：

```java
// DO转VO：分 → 元
private TradeConfigVO convertToVO(TradeConfigDO config) {
    TradeConfigVO vo = new TradeConfigVO();
    // ... 普通字段直接赋值
    
    // 金额字段转换：分 → 元
    if (config.getSameCityStartPrice() != null) {
        vo.setSameCityStartPrice(
            new BigDecimal(config.getSameCityStartPrice())
                .divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP)
        );
    }
    // ... 其他金额字段
    return vo;
}

// VO转DO：元 → 分
private TradeConfigDO convertToDO(TradeConfigVO vo) {
    TradeConfigDO config = new TradeConfigDO();
    // ... 普通字段直接赋值
    
    // 金额字段转换：元 → 分
    if (vo.getSameCityStartPrice() != null) {
        config.setSameCityStartPrice(
            vo.getSameCityStartPrice()
                .multiply(new BigDecimal("100"))
                .longValue()
        );
    }
    // ... 其他金额字段
    return config;
}
```

## 四、测试验证

### 4.1 单元测试

```java
@Test
public void testConfigSave() {
    TradeConfigVO config = new TradeConfigVO();
    config.setSameCityChargeMode(1);
    config.setSameCityStartPrice(new BigDecimal("10.00"));
    config.setSameCityStartDistance(new BigDecimal("3.00"));
    
    configService.saveConfig(config);
    
    TradeConfigVO queried = configService.getConfig();
    assertEquals(1, queried.getSameCityChargeMode());
    assertEquals(new BigDecimal("10.00"), queried.getSameCityStartPrice());
}
```

### 4.2 集成测试

```java
@Test
public void testAmountConversion() {
    // 测试元转分
    BigDecimal yuan = new BigDecimal("10.50");
    long cents = yuan.multiply(new BigDecimal("100")).longValue();
    assertEquals(1050L, cents);
    
    // 测试分转元
    long cents2 = 1050L;
    BigDecimal yuan2 = new BigDecimal(cents2)
        .divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP);
    assertEquals(new BigDecimal("10.50"), yuan2);
}
```

### 4.3 前端联调

1. 启动后端服务
2. 访问配置页面
3. 填写同城配送和门店自配送配置
4. 保存并验证数据是否正确

## 五、回滚方案

### 5.1 如果执行失败

```sql
-- 查看错误信息
SHOW ERRORS;

-- 查看警告信息
SHOW WARNINGS;
```

### 5.2 如果需要回滚

```bash
# 恢复备份
mysql -u用户名 -p数据库名 < trade_config_backup_YYYYMMDD_HHMMSS.sql
```

或者执行回滚脚本（在 ALTER 语句文件末尾已提供）

## 六、常见问题

### 6.1 字段已存在错误

如果提示字段已存在：
```sql
-- 检查字段是否存在
SHOW COLUMNS FROM trade_config WHERE Field = '字段名';

-- 如果存在且类型不对，先修改类型
ALTER TABLE trade_config MODIFY COLUMN 字段名 新类型;
```

### 6.2 默认值设置错误

```sql
-- 修改字段默认值
ALTER TABLE trade_config 
ALTER COLUMN 字段名 SET DEFAULT 默认值;
```

### 6.3 字符集问题

如果出现字符集错误：
```sql
-- 检查表字符集
SHOW CREATE TABLE trade_config;

-- 确保使用utf8mb4
ALTER TABLE trade_config CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 七、执行时间预估

- **ALTER语句执行**：约1-2分钟（51个字段）
- **验证检查**：约5分钟
- **后端代码调整**：约2-4小时
- **测试验证**：约1-2小时

**总计**：约3-7小时（不包括测试）

## 八、执行检查清单

- [ ] 已备份数据库
- [ ] 已检查现有表结构
- [ ] 已确认MySQL版本 >= 5.7
- [ ] 已执行ALTER语句
- [ ] 已验证新增字段
- [ ] 已检查数据完整性
- [ ] 已更新实体类（DO）
- [ ] 已更新VO类
- [ ] 已实现金额转换逻辑
- [ ] 已编写单元测试
- [ ] 已进行集成测试
- [ ] 已进行前端联调
- [ ] 已更新API文档

## 九、联系方式

如有问题，请联系：
- 数据库管理员
- 后端开发负责人
- 技术负责人

